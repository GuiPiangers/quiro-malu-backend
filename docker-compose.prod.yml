name: quiro

services:
  # ================================================
  # Servidor Webhook de Deploy
  # ================================================
  deploy-webhook:
    build:
      context: .
      dockerfile: Dockerfile.deploy
      args:
        DOCKER_GID: ${DOCKER_GID:-999}
    container_name: deploy-webhook
    restart: always
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3333
      - DEPLOY_SECRET=${DEPLOY_SECRET}
      - DOCKER_USERNAME=${DOCKER_USERNAME}
      - DOCKER_PASSWORD=${DOCKER_PASSWORD}
      - HOME=/home/webhookuser
      - DOCKER_CONFIG=/home/webhookuser/.docker
    group_add:
      - "${DOCKER_GID:-999}"

    # Porta apenas localhost (segurança)
    ports:
      - "127.0.0.1:3333:3333"

    volumes:
      # Socket do Docker (SEM :ro para permitir comandos)
      - /var/run/docker.sock:/var/run/docker.sock
      # Compose file para deploy
      - ./docker-compose.prod.yml:/app/docker-compose.yml:ro
      # Compose file para release deploy
      - ./docker-compose.release.yml:/app/docker-compose.release.yml:ro
      # Env file para docker compose
      - ./.env:/app/.env:ro
      # Env file para release compose
      - ./.env.release:/app/.env.release:ro
      # Script de deploy
      - ./deploy/deploy.sh:/usr/local/bin/deploy.sh:ro
      # Logs
      - /var/log/deploy-agent.log:/var/log/deploy-agent.log

    networks:
      - minha_rede

    labels:
      logging: "promtail"
      logging_jobname: "deploy-webhook"
      app_type: "webhook"

    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3333/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================================
  # Aplicação Backend
  # ================================================
  app:
    restart: always
    container_name: app
    image: guipiangers/quiro-backend:latest
    env_file:
      - .env
    volumes:
      - app-logs:/var/log/app
    depends_on:
      - redis
      - mysql-db
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "backend"
      app_type: "nodejs"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ================================================
  # MySQL Database
  # ================================================
  mysql-db:
    image: mysql:8.0
    container_name: mysqldb
    restart: always
    env_file:
      - .env
    volumes:
      - db:/var/lib/mysql
      - mysql-logs:/var/log/mysql
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "mysql"
      app_type: "database"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # MongoDB
  # ================================================
  mongo:
    image: mongo:8.0.4
    container_name: mongo
    restart: always
    env_file:
      - .env
    volumes:
      - mongoDb:/data/db
      - mongo-logs:/var/log/mongodb
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "mongodb"
      app_type: "database"
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # Redis Cache
  # ================================================
  redis:
    image: redis:7.4.2-alpine
    container_name: redis
    restart: always
    env_file:
      - .env
    volumes:
      - redisDb:/data
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "redis"
      app_type: "cache"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # Nginx Reverse Proxy
  # ================================================
  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    ports:
      - "${NGINX_PORT:-80}:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - nginx-logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "nginx"
      app_type: "proxy"

  # ================================================
  # Prometheus (Métricas)
  # ================================================
  prometheus:
    container_name: prometheus
    image: prom/prometheus
    restart: always
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "prometheus"

  # ================================================
  # Grafana (Visualização)
  # ================================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "grafana"
    depends_on:
      - loki
      - prometheus

  # ================================================
  # Loki (Armazenamento de Logs)
  # ================================================
  loki:
    image: grafana/loki:2.9.3
    container_name: loki
    restart: always
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - minha_rede
    labels:
      logging: "promtail"
      logging_jobname: "loki"

  # ================================================
  # Promtail (Coleta de Logs)
  # ================================================
  promtail:
    image: grafana/promtail:3.1.0
    container_name: promtail
    restart: always
    volumes:
      # Configuração do Promtail
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml
      # Socket do Docker para service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Logs dos containers
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Logs específicos dos serviços
      - nginx-logs:/var/log/nginx:ro
      - app-logs:/var/log/app:ro
      - mysql-logs:/var/log/mysql:ro
      - mongo-logs:/var/log/mongodb:ro
      - /var/log/deploy-agent.log:/var/log/deploy/deploy-agent.log:ro
      # Logs Release
      - nginx-logs-release:/var/log/nginx-release:ro
      - app-logs-release:/var/log/app-release:ro
      - mysql-logs-release:/var/log/mysql-release:ro
      - mongo-logs-release:/var/log/mongodb-release:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - minha_rede
    depends_on:
      - loki

# ================================================
# Volumes
# ================================================
volumes:
  db:
  mongoDb:
  redisDb:
  loki-data:
  grafana-data:
  prometheus-data:
  nginx-logs:
  app-logs:
  mysql-logs:
  mongo-logs: # Volumes Release (externos)

  nginx-logs-release:
    external: true
    name: quiro_nginx-logs-release
  app-logs-release:
    external: true
    name: quiro_app-logs-release
  mysql-logs-release:
    external: true
    name: quiro_mysql-logs-release
  mongo-logs-release:
    external: true
    name: quiro_mongo-logs-release
    # ================================================
    # Networks
    # ================================================
networks:
  minha_rede:
    driver: bridge
