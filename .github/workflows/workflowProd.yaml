name: Continues Integration and Delivery

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Setup cloudflared (safe action)
        uses: AnimMouse/setup-cloudflared@v2

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519

          cat >> ~/.ssh/config <<EOL
          Host meu-servidor
            HostName ssh.quiromalu.com.br
            User guilherme
            ProxyCommand cloudflared access ssh --hostname %h
          EOL

          mkdir -p ~/.cloudflared
          echo "${{ secrets.CLOUDFLARED_CERT }}" > ~/.cloudflared/cert.pem
          chmod 600 ~/.cloudflared/cert.pem

      - name: Testar conexão SSH
        run: ssh -o StrictHostKeyChecking=no meu-servidor "echo Conexão funcionando!"
