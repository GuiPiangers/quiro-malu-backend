name: quiro

services:
  # ================================================
  # Aplicação Backend
  # ================================================
  release-app:
    restart: always
    image: guipiangers/quiro-backend:latest
    env_file:
      - .env.release
    volumes:
      - app-logs-release:/var/log/app
    depends_on:
      - release-redis
      - release-mysql-db
    networks:
      - release_network
    labels:
      logging: "promtail"
      logging_jobname: "backend-release"
      app_type: "nodejs"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ================================================
  # MySQL Database
  # ================================================
  release-mysql-db:
    image: mysql:8.0
    restart: always
    env_file:
      - .env.release
    volumes:
      - db-release:/var/lib/mysql
      - mysql-logs-release:/var/log/mysql
    networks:
      - release_network
    labels:
      logging: "promtail"
      logging_jobname: "mysql-release"
      app_type: "database"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # MongoDB
  # ================================================
  release-mongo:
    image: mongo:8.0.4
    restart: always
    env_file:
      - .env.release
    volumes:
      - mongoDb-release:/data/db
      - mongo-logs-release:/var/log/mongodb
    networks:
      - release_network
    labels:
      logging: "promtail"
      logging_jobname: "mongodb-release"
      app_type: "database"
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # Redis Cache
  # ================================================
  release-redis:
    image: redis:7.4.2-alpine
    restart: always
    env_file:
      - .env.release
    volumes:
      - redisDb-release:/data
    networks:
      - release_network
    labels:
      logging: "promtail"
      logging_jobname: "redis-release"
      app_type: "cache"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================
  # Nginx Reverse Proxy
  # ================================================
  release-nginx:
    image: nginx:latest
    restart: always
    ports:
      - "${NGINX_PORT:-80}:80"
      - "4444:443"
    volumes:
      - ./nginx/nginx.release.conf:/etc/nginx/nginx.conf
      - nginx-logs-release:/var/log/nginx
    depends_on:
      - release-app
    networks:
      - release_network
    labels:
      logging: "promtail"
      logging_jobname: "nginx-release"
      app_type: "proxy"

# ================================================
# Volumes
# ================================================
volumes:
  db-release:
  mongoDb-release:
  redisDb-release:
  nginx-logs-release:
  app-logs-release:
  mysql-logs-release:
  mongo-logs-release:

    # ================================================
    # Networks
    # ================================================
networks:
  release_network:
    driver: bridge
